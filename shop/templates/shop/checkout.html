{% extends "shop/basic.html" %}
{% load static %}

{% block title %}Checkout - Outfit Avenue{% endblock %}

{% block hero_title %}Secure Checkout{% endblock %}
{% block hero_description %}Complete your order with confidence{% endblock %}

{% block extra_css %}
<style>
  .alert-success svg {
    width: 2em;
    height: auto;
  }
</style>
{% endblock %}

{% block shop_content %}
  <!-- Success Alert -->
  <div class="alert alert-success d-none align-items-center mb-4" role="alert" data-aos="fade-down">
    <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Success:">
      <use xlink:href="#check-circle-fill"/>
    </svg>
    <div class="ms-2">
      <h4 class="alert-heading">Thank you for Shopping!!</h4>
      <p>Your order has been received Successfully! , Your Order ID is - {{ order_id }}</p>
      <p>Track Your Order : <a href="/shop/tracker/">Click here!</a></p>
    </div>
  </div>

  <div class="container">
    <div class="col my-4">
      <h2 class="epic text-center">Outfit Avenue Express checkout - Review your cart items</h2>
      <div id="items">
        <ul class="list-group">
        </ul>
      </div>
      <hr>
      <nav aria-label="breadcrumb">
        <ul class="breadcrumb mt-3">
          <li class="breadcrumb-item active" aria-current="page">Your Cart Total is <b>Rs.<span id="totalPrice"></b></span> Enter your details below & place your order. Thanks for using Outfit Avenue</li>
        </ul>
      </nav>
    </div>
    <div class="col my-4">
      <h2 class="epic text-center">Enter Your Address Details.</h2>
      <form class="row" action="/shop/checkout/" method="post" onsubmit="return formValidate()"> 
        {% csrf_token %}
        <input type="hidden" name="itemsJson" id="itemsJson">
        <div class="form-group col-md-6 my-2">
          <label for="name">Name :</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="Enter Your Name">
        </div>
        <div class="form-group col-md-6 my-2">
          <label for="email">Email :</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="Enter Your Email">
        </div>
        <div class="form-group my-2">
          <label for="address1">Address Line 1 :</label>
          <input type="text" class="form-control" id="address1" name="address1" placeholder="Enter your Address line 1">
        </div>
        <div class="form-group my-2">
          <label for="address2">Address Line 2 :</label>
          <input type="text" class="form-control" id="address2" name="address2" placeholder="Enter your Address line 2">
        </div>
        <div class="form-group col-md-7 my-2">
          <label for="city">City :</label>
          <input type="text" class="form-control" id="city" name="city">
        </div>
        <div class="form-group col-md-5 my-2">
          <label for="zip_code">Zip :</label>
          <input type="text" class="form-control" id="zip_code" name="zip_code">
        </div>
        <div class="form-group my-2">
          <label for="phone">Phone Number :</label>
          <input type="tel" class="form-control" id="phone" name="phone">
        </div>
        <div class="text-center my-2">
          <button type="submit" class="btn btn-dark epic">Place Order</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}



{% block extra_js %}
<script>
//Validation of Form
function formValidate() {
  var name = document.getElementById("name").value;
  var email = document.getElementById("email").value;
  var phone = document.getElementById("phone").value;

  const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
  const phoneRegex = /^[(]{0,1}[0-9]{3}[)]{0,1}[-\s\.]{0,1}[0-9]{3}[-\s\.]{0,1}[0-9]{4}$/;

  if (name.trim() === "") {
    alert("Name cannot be empty");
    return false;
  }

  if (!emailRegex.test(email)) {
    alert("Invalid Email Address!!! Enter Valid Email Address");
    return false;
  }

  if (!phoneRegex.test(phone)) {
    alert("Invalid Phone Number!!! Enter Valid Phone Number");
    return false;
  }
  return true;
}

// Additional Script for cart items showing in our cart page:

if (localStorage.getItem('cart') == null) {
  var cart = {};
} else {
  cart = JSON.parse(localStorage.getItem('cart'));
}
console.log(cart);
var sum = 0;
var totalPrice = 0;
if ($.isEmptyObject(cart)) {
    //if object is empty
    mystr =  `<p>Your cart is empty, please add some items to your cart before checking out!</p>`
    $('#items').append(mystr);
} else {
    for (item in cart) {
        let name = cart[item][1];
        let qty = cart[item][0];
        let itemPrice = cart[item][2];
        sum = sum + qty;
        totalPrice = totalPrice + qty * itemPrice;
        mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
          ${name}
          <span class="badge bg-primary rounded-pill">${qty}</span>
      </li>`;
        $('#items').append(mystr);
    }
}
document.getElementById('totalPrice').innerHTML = totalPrice;

// after placing an order show alert.
$('#itemsJson').val(JSON.stringify(cart));
// Check if 'thank' flag is present in localStorage
var thankFlag = localStorage.getItem('thank');

// Success alert and cart cleanup handled when order_id is present
(function(){
  var orderId = '{{ order_id|default:"" }}';
  if (!orderId) return;
  var el = document.querySelector('.alert.alert-success');
  if (el && !localStorage.getItem('orderSuccess')) {
    el.classList.remove('d-none', 'align-items-center');
    el.classList.add('d-flex');
    localStorage.setItem('orderSuccess', 'true');
  }
  try {
    var cartStr = localStorage.getItem('cart');
    if (cartStr) {
      localStorage.setItem('cart', '{}');
    }
    localStorage.removeItem('thank');
  } catch (e) {}
})();
</script>
{% endblock %}