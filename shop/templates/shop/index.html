{% extends 'shop/basic.html' %}
{% load static %}

{% block title %}Shop - Outfit Avenue{% endblock %}

{% block hero_title %}Discover Our Collection{% endblock %}
{% block hero_description %}Explore the latest trends and timeless classics in our curated fashion collection{% endblock %}

{% block shop_content %}
  <!-- Filter Buttons -->
  <div class="filter-buttons" data-aos="fade-up">
    <button class="filter-btn active" data-category="all">All Products</button>
    <a href="/shop/mencat/" class="filter-btn" data-category="men">Men's Fashion</a>
    <a href="/shop/womencat/" class="filter-btn" data-category="women">Women's Fashion</a>
    <a href="/shop/kidscat/" class="filter-btn" data-category="kids">Kids Wear</a>
  </div>

  <!-- Products Section -->
  {% for product, range, nSlides in allProds %}
    <div class="section-header" data-aos="fade-up">
      <h2 class="section-title">{{ product.0.category }}</h2>
      <p class="section-subtitle">Discover our curated collection of {{ product.0.category|lower }}</p>
      </div>

    <div class="row g-4 mb-5">
        {% for i in product %}
        <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:100 }}">
          <div class="product-card" data-category="{{ product.0.category }}">
            <div class="product-image" style="background-image: url('/media/{{ i.image }}');">
              <div class="product-overlay">
                <a href="{% url 'ProductView' i.id %}" class="btn btn-light btn-lg quick-view-btn"
                   data-product-id="{{ i.id }}"
                   data-product-name="{{ i.product_name }}"
                   data-product-price="{{ i.price }}"
                   data-product-category="{{ product.0.category }}"
                   data-product-image="/media/{{ i.image }}">
                  <i class="fas fa-eye me-2"></i>Quick View
                </a>
            </div>
          </div>
            <div class="product-info">
              <h5 class="product-title" id="namepr{{ i.id }}">{{ i.product_name }}</h5>
              <div class="product-price">₹<span id="pricepr{{ i.id }}">{{ i.price }}</span></div>
              <div class="d-flex justify-content-center align-items-center">
                <div id="divpr{{ i.id }}" class="divpr">
                  <button id="pr{{ i.id }}" class="btn btn-primary-custom btn-sm add-to-cart" 
                          data-product-id="{{ i.id }}" 
                          data-product-name="{{ i.product_name }}" 
                          data-product-price="{{ i.price }}">
                    <i class="fas fa-shopping-cart me-1"></i>Add to Cart
                  </button>
                </div>
              </div>
</div>
</div>
        </div>
    {% endfor %}
</div>
  {% empty %}
    <div class="empty-state" data-aos="fade-up">
      <i class="fas fa-shopping-bag"></i>
      <h3>No Products Available</h3>
      <p>We're working on adding amazing products to our collection. Check back soon!</p>
    </div>
  {% endfor %}

  <!-- Quick View Modal -->
  <div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="quickViewModalLabel">Product Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <img id="modalProductImage" src="" alt="Product Image" class="img-fluid rounded">
            </div>
            <div class="col-md-6">
              <h4 id="modalProductName" class="mb-3"></h4>
              <div class="product-price mb-3">
                <span class="h3 text-primary">₹<span id="modalProductPrice"></span></span>
              </div>
              <div class="mb-3">
                <span class="category-badge" id="modalProductCategory"></span>
              </div>
              <div class="product-description mb-4">
                <h6>Description:</h6>
                <p id="modalProductDescription" class="text-muted"></p>
              </div>
              <div class="product-features mb-4">
                <h6>Features:</h6>
                <ul id="modalProductFeatures" class="list-unstyled">
                  <!-- Features will be populated by JavaScript -->
                </ul>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary-custom add-to-cart-modal" id="modalAddToCartBtn">
                  <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 {% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
  // Enhanced functionality for shop index
  $(document).ready(function() {
    // Cart functionality is now handled globally in base.html
    // Initialize cart display on page load
    if (typeof updateCartButtons === 'function') {
      const cart = JSON.parse(localStorage.getItem('cart') || '{}');
      updateCartButtons(cart);
    }

    // Quick View functionality
    $(document).on('click', '.quick-view-btn', function(e) {
      e.preventDefault();
      console.log('Quick View button clicked!');
      
      const productId = $(this).data('product-id');
      const productName = $(this).data('product-name');
      const productPrice = $(this).data('product-price');
      const productCategory = $(this).data('product-category');
      const productImage = $(this).data('product-image');
      
      console.log('Product data:', {productId, productName, productPrice, productCategory, productImage});
      
      // Populate modal with product data
      $('#modalProductName').text(productName);
      $('#modalProductPrice').text(productPrice);
      $('#modalProductCategory').text(productCategory);
      $('#modalProductImage').attr('src', productImage);
      
      // Generate product description based on category and name
      const description = generateProductDescription(productName, productCategory);
      $('#modalProductDescription').text(description);
      
      // Generate product features
      const features = generateProductFeatures(productName, productCategory);
      $('#modalProductFeatures').html(features);
      
      // Set up modal add to cart button
      $('.add-to-cart-modal').off('click').on('click', function() {
        addToCartFromModal(productId, productName, productPrice);
        $('#quickViewModal').modal('hide');
      });
      
      // Show modal
      console.log('Attempting to show modal...');
      $('#quickViewModal').modal('show');
      console.log('Modal show called');
    });

    // Plus/minus functionality is now handled globally in base.html

    // Enhanced Filter functionality with smooth scrolling
    $('.filter-btn').click(function() {
      $('.filter-btn').removeClass('active');
      $(this).addClass('active');
      
      const category = $(this).data('category');
      filterProducts(category);
      
      // Smooth scroll to products section
      $('html, body').animate({
        scrollTop: $('.filter-buttons').offset().top - 100
      }, 800);
    });
  });

  // Generate product description based on product name and category
  function generateProductDescription(productName, category) {
    const descriptions = {
      'Men\'s Fashion': {
        'Kurtas': 'Crafted from premium cotton fabric, this elegant kurta features traditional Indian design with modern comfort. Perfect for festive occasions, weddings, and cultural celebrations. The straight full sleeve design ensures a comfortable fit while maintaining the classic ethnic look.',
        'Shirts': 'A versatile addition to your wardrobe, this shirt combines style with functionality. Made from high-quality fabric, it offers comfort for both casual and semi-formal occasions. The contemporary design ensures you look sharp and confident.',
        'Sherwani': 'An exquisite piece of traditional Indian menswear, this sherwani is perfect for special occasions. Featuring intricate embroidery and premium fabric, it embodies elegance and sophistication. Ideal for weddings, festivals, and formal events.',
        'T-Shirts': 'Comfort meets style in this premium cotton t-shirt. Designed for everyday wear, it offers a perfect blend of comfort and fashion. The soft fabric and modern cut ensure you stay comfortable while looking trendy.',
        'Jeans': 'Classic denim jeans that never go out of style. Made from durable cotton denim, these jeans offer comfort and longevity. Perfect for casual outings, they provide a timeless look that complements any outfit.'
      },
      'Women\'s Fashion': {
        'Kurtas': 'A beautiful straight full sleeve cotton kurta that combines traditional elegance with modern comfort. Perfect for daily wear, office, or casual outings. The breathable cotton fabric ensures comfort throughout the day while maintaining a stylish appearance.',
        'Sarees': 'An elegant ethnic saree crafted from premium cotton fabric. This timeless piece features traditional patterns and colors that celebrate Indian culture. Perfect for festivals, weddings, and special occasions. The comfortable drape and beautiful design make it a must-have in every woman\'s wardrobe.',
        'Lehenga Choli': 'A stunning semi-stitched lehenga choli set that embodies grace and elegance. Perfect for weddings, festivals, and special celebrations. The intricate embroidery and premium fabric create a luxurious look that makes you stand out on any special occasion.',
        'Jackets': 'A stylish printed open front jacket that adds a contemporary touch to your wardrobe. Perfect for layering over kurtas or pairing with modern outfits. The versatile design allows for multiple styling options, making it a valuable addition to your collection.',
        'Dresses': 'A chic and comfortable dress designed for the modern woman. Featuring contemporary cuts and premium fabric, this dress is perfect for both casual and semi-formal occasions. The elegant design ensures you look confident and stylish wherever you go.'
      },
      'Kids Wear': {
        'Kurtas': 'Adorable kids\' kurta made from soft, comfortable cotton fabric. Perfect for festivals, family gatherings, and special occasions. The child-friendly design ensures comfort while maintaining the traditional ethnic look that parents love.',
        'Dresses': 'Cute and comfortable dress designed specifically for little ones. Made from soft, skin-friendly fabric, it ensures your child stays comfortable while looking adorable. Perfect for parties, school events, and casual outings.',
        'Shirts': 'Stylish kids\' shirt that combines comfort with fashion. Made from high-quality, breathable fabric, it\'s perfect for school, playtime, and casual outings. The durable construction ensures it withstands active play while maintaining its appearance.',
        'Jeans': 'Durable and comfortable jeans designed for active kids. Made from soft denim fabric, these jeans are perfect for school, play, and casual outings. The reinforced construction ensures they last through all your child\'s adventures.'
      }
    };
    
    // Find matching description
    for (const key in descriptions[category]) {
      if (productName.toLowerCase().includes(key.toLowerCase())) {
        return descriptions[category][key];
      }
    }
    
    // Default description
    return `A beautiful ${category.toLowerCase()} piece that combines style with comfort. Made from premium materials, this item is perfect for various occasions and ensures you look and feel great. The quality construction and attention to detail make it a valuable addition to your wardrobe.`;
  }

  // Generate product features based on product name and category
  function generateProductFeatures(productName, category) {
    const features = {
      'Men\'s Fashion': [
        '<li><i class="fas fa-check text-success me-2"></i>Premium Quality Fabric</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Comfortable Fit</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Easy Care Instructions</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Durable Construction</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Modern Design</li>'
      ],
      'Women\'s Fashion': [
        '<li><i class="fas fa-check text-success me-2"></i>Elegant Design</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Premium Fabric</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Perfect Fit</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Easy Maintenance</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Versatile Styling</li>'
      ],
      'Kids Wear': [
        '<li><i class="fas fa-check text-success me-2"></i>Child-Safe Materials</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Comfortable Fit</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Durable Construction</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Easy to Clean</li>',
        '<li><i class="fas fa-check text-success me-2"></i>Fun Design</li>'
      ]
    };
    
    return features[category] ? features[category].join('') : features['Men\'s Fashion'].join('');
  }

  // Add to cart from modal - uses global cart system from base.html
  function addToCartFromModal(productId, productName, productPrice) {
    // Ensure cart exists in localStorage
    if (typeof localStorage === 'undefined') {
      console.error('localStorage is not available');
      return;
    }
    
    // Get cart from localStorage (global cart system)
    let cart = {};
    try {
      const cartStr = localStorage.getItem('cart');
      cart = cartStr ? JSON.parse(cartStr) : {};
    } catch (e) {
      console.error('Error parsing cart:', e);
      cart = {};
    }
    
    // Create cart key (no variants for Quick View - default)
    const key = 'pr' + productId;
    
    // Add or update item in cart
    if (cart[key]) {
      cart[key][0] = cart[key][0] + 1; // Increment quantity
    } else {
      cart[key] = [1, productName, parseInt(productPrice), '', '']; // [quantity, name, price, size, color]
    }
    
    // Save cart to localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Update cart display using global functions from base.html
    if (typeof window.updateCartDisplay === 'function') {
      window.updateCartDisplay();
    }
    if (typeof window.updateCartButtons === 'function') {
      window.updateCartButtons(cart);
    }
    if (typeof window.updatePopover === 'function') {
      window.updatePopover();
    }
    
    // Show success notification
    if (typeof showNotification === 'function') {
      showNotification('Added to cart!', 'success');
    } else {
      alert('Added to cart!');
    }
  }

  function filterProducts(category) {
    if (category === 'all') {
      $('.product-card').show();
      $('.section-header').show();
    } else {
      // Map filter categories to actual category names
      const categoryMap = {
        'men': 'Men\'s Fashion',
        'women': 'Women\'s Fashion', 
        'kids': 'Kids Wear'
      };
      
      const actualCategory = categoryMap[category];
      
      // Hide all products first
      $('.product-card').hide();
      $('.section-header').hide();
      
      // Show only products matching the selected category
      $(`.product-card[data-category="${actualCategory}"]`).show();
      
      // Show the section header for the filtered category
      $(`.section-header:has(.section-title:contains("${actualCategory}"))`).show();
    }
  }
  
  function showNotification(message, type) {
    const notification = $(`
      <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
           style="top: 100px; right: 20px; z-index: 9999; min-width: 300px;">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(() => {
      notification.alert('close');
    }, 3000);
  }
  </script>
{% endblock %}